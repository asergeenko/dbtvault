trigger:
  branches:
    include:
      - develop
      - feat/harness-refactor

pool:
  vmImage: ubuntu-latest

variables:
  SNOWFLAKE_DB_ACCOUNT: "$(SNOWFLAKE_DB_ACCOUNT)"
  SNOWFLAKE_DB_USER: "$(SNOWFLAKE_DB_USER)"
  SNOWFLAKE_DB_PW: "$(SNOWFLAKE_DB_PW)"
  SNOWFLAKE_DB_ROLE: "$(SNOWFLAKE_DB_ROLE)"
  SNOWFLAKE_DB_DATABASE: "$(SNOWFLAKE_DB_DATABASE)"
  SNOWFLAKE_DB_WH: "$(SNOWFLAKE_DB_WH)"
  SNOWFLAKE_DB_SCHEMA: "$(SNOWFLAKE_DB_SCHEMA)"

stages:
  - stage: 'Build_environment'
    jobs:
      - job: 'InstallDependencies'

        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.9'
          - script: pip install pipenv
            displayName: 'Install pipenv'
          - script: pipenv install --dev
            displayName: 'Install Pipenv dependencies'
          - script: inv run-harness-tests
            displayName: 'Harness Tests'
          - script: inv run-macro-tests -p snowflake
            displayName: 'Macro Tests - Snowflake'

      - job: 'UnitTests'

        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.9'
            displayName: 'Harness Tests'
          - script: inv run-macro-tests -p snowflake
            displayName: 'Macro Tests - Snowflake'